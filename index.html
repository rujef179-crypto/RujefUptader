<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Subir APK</title>
<style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, button { width: 100%; padding: 8px; margin-bottom: 10px; }
    button { background: #007cba; color: white; border: none; padding: 12px; cursor: pointer; }
    #resultado { margin-top: 20px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .loading { background: #fff3cd; color: #856404; }
</style>
</head>
<body>
  <h1>Subir APK Directamente a GitHub</h1>
  
  <form id="uploadForm">
    <div class="form-group">
      <label>APK:</label>
      <input type="file" id="apkFile" accept=".apk" required />
    </div>

    <div class="form-group">
      <label>Version Code:</label>
      <input type="number" id="versionCode" required />
    </div>

    <div class="form-group">
      <label>Version Name:</label>
      <input type="text" id="versionName" required />
    </div>

    <div class="form-group">
      <label>Agregados:</label>
      <input type="text" id="agregados" />
    </div>

    <div class="form-group">
      <label>Correcciones:</label>
      <input type="text" id="correcciones" />
    </div>

    <button type="submit">Subir APK a GitHub</button>
  </form>

  <div id="resultado"></div>

  <script>
    const form = document.getElementById('uploadForm');
    const resultado = document.getElementById('resultado');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      resultado.className = 'loading';
      resultado.textContent = "Subiendo APK directamente a GitHub...";

      const apkFile = document.getElementById('apkFile').files[0];
      const versionCode = document.getElementById('versionCode').value;
      const versionName = document.getElementById('versionName').value;
      const agregados = document.getElementById('agregados').value;
      const correcciones = document.getElementById('correcciones').value;

      try {
        // Leer el archivo APK como base64
        const fileBuffer = await readFileAsArrayBuffer(apkFile);
        const fileContent = arrayBufferToBase64(fileBuffer);
        const newName = `app-${versionName}-${Date.now()}.apk`;
        const apkPath = `public/apk/${newName}`;

        // Configuración de GitHub
        const owner = 'rujef179-crypto'; // Tu usuario
        const repo = 'RujefUptader'; // Tu repositorio
        const branch = 'main';
        const token = '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'; // ⚠️ Reemplaza con tu token

        // Subir APK a GitHub
        await uploadToGitHub({
          owner,
          repo,
          path: apkPath,
          message: `Subida nueva versión ${versionName} (v${versionCode})`,
          content: fileContent,
          branch,
          token
        });

        // Crear version.json
        const versionData = {
          versionCode: parseInt(versionCode),
          versionName: versionName,
          agregados: agregados || "",
          correcciones: correcciones || "",
          downloadUrl: `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${apkPath}`,
          timestamp: new Date().toISOString()
        };

        const versionContent = btoa(JSON.stringify(versionData, null, 2));

        await uploadToGitHub({
          owner,
          repo,
          path: "public/version.json",
          message: `Actualización versión ${versionName} (v${versionCode})`,
          content: versionContent,
          branch,
          token
        });

        resultado.className = 'success';
        resultado.textContent = "✅ APK subida y version.json actualizado correctamente en GitHub.";
        
      } catch (error) {
        resultado.className = 'error';
        resultado.textContent = "❌ Error: " + error.message;
        console.error('Error:', error);
      }
    });

    // Función para leer archivo como ArrayBuffer
    function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    // Convertir ArrayBuffer a base64
    function arrayBufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }

    // Función para subir a GitHub
    async function uploadToGitHub({ owner, repo, path, message, content, branch, token }) {
      const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: message,
          content: content,
          branch: branch
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Error al subir a GitHub');
      }

      return response.json();
    }
  </script>
</body>
</html>

